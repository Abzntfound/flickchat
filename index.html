<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
<title>FlickChat</title>
<link rel="icon" type="image/png" href="Olajide-Olayinka-Williams-Olatunji-true-potential-forehead.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#080810;--s1:#0f0f1a;--s2:#161624;--s3:#1e1e2e;--s4:#26263a;
  --border:#2a2a3e;--border2:#353550;
  --accent:#818cf8;--ad:#6366f1;--aglow:rgba(99,102,241,.18);--aglow2:rgba(99,102,241,.08);
  --rose:#fb7185;--green:#34d399;--amber:#fbbf24;
  --t1:#f0f0fa;--t2:#9090b0;--t3:#55556a;--t4:#333348;
  --r:14px;--r2:10px;--r3:20px;--sw:264px;
  --tr:.18s cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;}
input,textarea,button{font-family:inherit;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:10px;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--s4);border:1px solid var(--border2);color:var(--t1);padding:9px 20px;border-radius:40px;font-size:13px;font-weight:500;opacity:0;pointer-events:none;transition:all .3s;z-index:9999;white-space:nowrap;box-shadow:0 8px 30px rgba(0,0,0,.5);}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#auth{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;
  background:radial-gradient(ellipse 800px 600px at 20% 10%,rgba(99,102,241,.12) 0%,transparent 70%),
             radial-gradient(ellipse 600px 500px at 85% 85%,rgba(251,113,133,.07) 0%,transparent 65%),var(--bg);}
.acard{width:100%;max-width:420px;background:var(--s1);border:1px solid var(--border);border-radius:24px;padding:44px 40px;box-shadow:0 40px 100px rgba(0,0,0,.6);animation:rise .5s cubic-bezier(.16,1,.3,1) both;}
.alogo{font-family:'Instrument Serif',serif;font-size:36px;background:linear-gradient(135deg,#c7d2fe,#818cf8,#a5b4fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;letter-spacing:-.5px;}
.atag{font-size:13px;color:var(--t2);margin-bottom:28px;}
.tabs{display:flex;background:var(--s3);border-radius:10px;padding:4px;margin-bottom:22px;}
.tab{flex:1;padding:8px;border:none;background:transparent;color:var(--t2);border-radius:7px;cursor:pointer;font-size:13px;font-weight:600;transition:var(--tr);}
.tab.on{background:var(--ad);color:#fff;box-shadow:0 2px 10px rgba(99,102,241,.35);}
.lbl{display:block;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.inp{width:100%;padding:11px 14px;background:var(--s3);border:1px solid var(--border);border-radius:var(--r2);color:var(--t1);font-size:14px;outline:none;transition:border-color var(--tr);margin-bottom:12px;}
.inp:focus{border-color:var(--accent);}
.inp::placeholder{color:var(--t4);}
.inp:disabled{opacity:.5;cursor:not-allowed;}
.btn-p{width:100%;padding:12px;background:var(--ad);border:none;border-radius:var(--r2);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:var(--tr);}
.btn-p:hover:not(:disabled){background:var(--accent);box-shadow:0 6px 20px rgba(99,102,241,.4);}
.btn-p:active:not(:disabled){transform:scale(.98);}
.btn-p:disabled{opacity:.55;cursor:not-allowed;}
.aerr{font-size:13px;color:var(--rose);margin-top:10px;min-height:18px;line-height:1.4;}

/* ‚îÄ‚îÄ SHARED BTN VARIANTS ‚îÄ‚îÄ */
.btn-g{background:var(--s3);color:var(--t2);border:1px solid var(--border);border-radius:var(--r2);cursor:pointer;transition:var(--tr);}
.btn-g:hover{background:var(--s4);color:var(--t1);}
.btn-d{background:rgba(251,113,133,.1);color:var(--rose);border:1px solid rgba(251,113,133,.2);border-radius:var(--r2);cursor:pointer;transition:var(--tr);}
.btn-d:hover{background:rgba(251,113,133,.18);}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app{display:none;height:100vh;overflow:hidden;}
#app.on{display:flex;}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:99;display:none;}
#overlay.on{display:block;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sb{width:var(--sw);min-width:var(--sw);background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;transition:transform var(--tr);z-index:100;}
.sbtop{padding:16px 14px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sblogo{font-family:'Instrument Serif',serif;font-size:22px;background:linear-gradient(135deg,#c7d2fe,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.ib{background:none;border:none;color:var(--t3);cursor:pointer;width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:var(--tr);font-size:15px;flex-shrink:0;}
.ib:hover{background:var(--s3);color:var(--t1);}
.sbscr{flex:1;overflow-y:auto;padding:4px 0 8px;}
.sec{padding:14px 14px 4px;font-size:10px;font-weight:800;color:var(--t4);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;justify-content:space-between;}
.sec button{background:none;border:none;color:var(--t4);cursor:pointer;font-size:16px;line-height:1;padding:0 2px;transition:color var(--tr);}
.sec button:hover{color:var(--t2);}
.row{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:10px;margin:1px 6px;cursor:pointer;color:var(--t2);font-size:13px;font-weight:500;transition:background var(--tr),color var(--tr);}
.row:hover{background:var(--s3);color:var(--t1);}
.row.on{background:var(--aglow);color:var(--accent);}
.ri{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.rn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* av */
.av{border-radius:50%;background:var(--s3);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--t2);position:relative;}
.av img{width:100%;height:100%;object-fit:cover;display:block;}
.sz28{width:28px;height:28px;font-size:10px;}
.sz32{width:32px;height:32px;font-size:11px;}
.sz36{width:36px;height:36px;font-size:12px;}
.sz40{width:40px;height:40px;font-size:14px;}
.sz56{width:56px;height:56px;font-size:19px;}
.sz64{width:64px;height:64px;font-size:22px;}
.odot{position:absolute;bottom:0;right:0;width:9px;height:9px;background:var(--green);border:2px solid var(--s1);border-radius:50%;}
.odot.sm{width:7px;height:7px;}

/* sb footer */
.sbfoot{flex-shrink:0;border-top:1px solid var(--border);padding:10px 12px;display:flex;align-items:center;gap:9px;cursor:pointer;transition:background var(--tr);}
.sbfoot:hover{background:var(--s2);}
.sbfoot .fn{flex:1;min-width:0;}
.sbfoot .un{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sbfoot .us{font-size:11px;color:var(--t2);display:flex;align-items:center;gap:4px;}
.sbfoot .us::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;}

/* chat header */
.ch{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--s1);display:flex;align-items:center;gap:10px;flex-shrink:0;min-height:56px;}
.ci{font-size:18px;flex-shrink:0;}
.cn{font-size:15px;font-weight:800;}
.cd{font-size:11px;color:var(--t2);}
.chr{margin-left:auto;display:flex;gap:4px;}
.ham{display:none;}

/* members bar */
#mbar{background:var(--s1);border-bottom:1px solid var(--border);padding:8px 20px;display:none;align-items:center;gap:6px;flex-wrap:wrap;flex-shrink:0;min-height:44px;}
#mbar.on{display:flex;}
.mbarlbl{font-size:10px;font-weight:800;color:var(--t4);text-transform:uppercase;letter-spacing:.8px;margin-right:4px;}
.mchip{display:flex;align-items:center;gap:5px;padding:4px 9px 4px 5px;background:var(--s3);border:1px solid var(--border);border-radius:20px;font-size:11px;font-weight:600;color:var(--t3);transition:var(--tr);}
.mchip.live{border-color:rgba(52,211,153,.3);color:var(--t1);}
.mchip .mdot{width:6px;height:6px;border-radius:50%;background:var(--border2);flex-shrink:0;}
.mchip.live .mdot{background:var(--green);}
.mchip .mav{width:18px;height:18px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--s4);font-size:7px;font-weight:800;flex-shrink:0;}
.mchip .mav img{width:100%;height:100%;object-fit:cover;}

/* messages */
.msgs{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:0;}
.dsep{display:flex;align-items:center;gap:10px;padding:12px 0;font-size:11px;font-weight:700;color:var(--t4);}
.dsep::before,.dsep::after{content:'';flex:1;height:1px;background:var(--border);}

/* message group */
.mg{display:flex;gap:10px;padding:3px 4px;position:relative;border-radius:8px;transition:background .1s;}
.mg:hover{background:rgba(255,255,255,.018);}
.mg:hover .ma{opacity:1;}
.mright{flex:1;min-width:0;}
.mmeta{display:flex;align-items:baseline;gap:7px;margin-bottom:3px;}
.mauth{font-size:13px;font-weight:700;cursor:pointer;}
.mauth:hover{text-decoration:underline;}
.mtime{font-size:10px;color:var(--t4);}
.mdel{font-size:13px;color:var(--t4);font-style:italic;}

/* reply quote */
.rq{background:var(--s3);border-left:3px solid var(--accent);border-radius:6px;padding:6px 10px;margin-bottom:5px;cursor:pointer;max-width:480px;}
.rq:hover{background:var(--s4);}
.rqau{font-size:11px;font-weight:700;color:var(--accent);margin-bottom:2px;}
.rqtx{font-size:12px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* bubble */
.bub{display:inline-block;max-width:min(480px,88%);word-break:break-word;background:var(--s2);border:1px solid var(--border);border-radius:4px 14px 14px 14px;padding:8px 13px;font-size:14px;line-height:1.55;color:var(--t1);}
.bub.me{background:linear-gradient(135deg,var(--ad),#818cf8);border-color:transparent;color:#fff;border-radius:14px 4px 14px 14px;}

/* reactions */
.reacts{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;}
.rp{display:flex;align-items:center;gap:3px;padding:3px 8px;background:var(--s3);border:1px solid var(--border);border-radius:20px;font-size:13px;cursor:pointer;transition:var(--tr);user-select:none;}
.rp:hover{border-color:var(--accent);}
.rp.mine{background:var(--aglow);border-color:var(--accent);}
.rp span{font-size:11px;color:var(--t2);}

/* action bar */
.ma{position:absolute;right:4px;top:-14px;display:flex;gap:2px;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:3px;opacity:0;transition:opacity var(--tr);z-index:10;box-shadow:0 6px 24px rgba(0,0,0,.5);}
.ab{background:none;border:none;color:var(--t2);cursor:pointer;padding:5px 7px;border-radius:7px;font-size:14px;transition:var(--tr);position:relative;}
.ab:hover{background:var(--s3);color:var(--t1);}
.ab.del:hover{color:var(--rose);}

/* emoji tray */
.et{position:absolute;right:0;top:34px;background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:8px;display:flex;gap:3px;flex-wrap:wrap;width:196px;z-index:50;box-shadow:0 12px 40px rgba(0,0,0,.6);animation:fadeUp .15s ease both;}
.et button{background:none;border:none;cursor:pointer;font-size:18px;padding:4px;border-radius:6px;transition:background .1s;}
.et button:hover{background:var(--s3);}

/* reply strip */
#rstrip{display:none;background:var(--s2);border-top:1px solid var(--border);padding:7px 20px;align-items:center;gap:8px;font-size:13px;color:var(--t2);flex-shrink:0;}
#rstrip.on{display:flex;}
.rstripclose{background:none;border:none;color:var(--t3);cursor:pointer;font-size:18px;margin-left:auto;line-height:1;}

/* input zone */
.izone{padding:10px 20px 14px;background:var(--s1);border-top:1px solid var(--border);flex-shrink:0;}
.ibox{display:flex;gap:8px;align-items:flex-end;background:var(--s3);border:1px solid var(--border);border-radius:14px;padding:8px 10px;transition:border-color var(--tr);}
.ibox:focus-within{border-color:var(--accent);}
#minput{flex:1;background:none;border:none;color:var(--t1);font-size:14px;resize:none;outline:none;max-height:120px;min-height:22px;line-height:1.5;padding:1px 4px;}
#minput::placeholder{color:var(--t4);}
.sbtn{background:var(--ad);border:none;color:#fff;width:32px;height:32px;border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;transition:var(--tr);}
.sbtn:hover{background:var(--accent);}
.sbtn:active{transform:scale(.9);}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.72);display:flex;align-items:center;justify-content:center;z-index:500;backdrop-filter:blur(6px);padding:20px;animation:fadeIn .2s;}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:22px;padding:30px;width:100%;max-width:440px;box-shadow:0 40px 100px rgba(0,0,0,.7);animation:rise .25s cubic-bezier(.16,1,.3,1) both;max-height:90vh;overflow-y:auto;position:relative;}
.modal h3{font-size:18px;font-weight:800;margin-bottom:4px;}
.msub{font-size:13px;color:var(--t2);margin-bottom:20px;}
.mclose{position:absolute;top:14px;right:14px;background:var(--s3);border:none;color:var(--t2);cursor:pointer;width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:16px;transition:var(--tr);}
.mclose:hover{background:var(--s4);color:var(--t1);}
.mf{margin-bottom:14px;}
.mf .lbl{display:block;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.mf .inp{margin-bottom:0;}

/* settings */
.stabs{display:flex;background:var(--s3);border-radius:10px;padding:4px;margin-bottom:20px;}
.stab{flex:1;padding:8px 4px;border:none;background:transparent;color:var(--t2);border-radius:7px;cursor:pointer;font-size:12px;font-weight:700;transition:var(--tr);}
.stab.on{background:var(--ad);color:#fff;}
.ssec{display:none;}
.ssec.on{display:block;}

/* avatar picker */
.avpick{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.avprev{width:64px;height:64px;border-radius:50%;background:var(--s3);border:2px solid var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:var(--t2);flex-shrink:0;}
.avprev img{width:100%;height:100%;object-fit:cover;}
.avopts{display:flex;flex-direction:column;gap:8px;}
.avopt{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--s2);color:var(--t2);font-size:12px;font-weight:600;cursor:pointer;transition:var(--tr);}
.avopt:hover{border-color:var(--accent);color:var(--t1);}

/* user list */
.ulist{display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto;}
.urow{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--s2);border:1px solid var(--border);border-radius:10px;}
.urinfo{flex:1;min-width:0;}
.urname{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ursub{font-size:11px;color:var(--t2);}
.urbtn{padding:5px 12px;border-radius:7px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:var(--tr);white-space:nowrap;}
.u-add{background:var(--aglow);color:var(--accent);border:1px solid rgba(99,102,241,.3);}
.u-add:hover{background:var(--ad);color:#fff;}
.u-rem{background:rgba(251,113,133,.1);color:var(--rose);border:1px solid rgba(251,113,133,.2);}
.u-rem:hover{background:rgba(251,113,133,.18);}
.u-acc{background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.2);}
.u-acc:hover{background:rgba(52,211,153,.18);}
.u-msg{background:var(--aglow);color:var(--accent);border:1px solid rgba(99,102,241,.3);}
.u-msg:hover{background:var(--ad);color:#fff;}
.empty{text-align:center;padding:28px;color:var(--t3);font-size:13px;}

/* checkmark for GC select */
.chk{width:20px;height:20px;border-radius:6px;border:2px solid var(--border2);background:var(--s3);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--tr);}
.chk.on{background:var(--ad);border-color:var(--ad);}
.chk.on::after{content:'‚úì';font-size:11px;color:#fff;font-weight:800;}

/* profile popup */
.ppop{position:fixed;background:var(--s1);border:1px solid var(--border2);border-radius:18px;padding:20px;width:220px;z-index:300;box-shadow:0 20px 60px rgba(0,0,0,.75);animation:fadeUp .2s ease both;}
.ppname{font-size:15px;font-weight:800;margin-bottom:2px;}
.ppstatus{font-size:12px;color:var(--t2);margin-bottom:8px;}
.pponline{font-size:12px;color:var(--green);display:flex;align-items:center;gap:5px;margin-bottom:14px;}
.pponline::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0;}
.ppoffline{font-size:12px;color:var(--t3);margin-bottom:14px;}
.ppbtn{width:100%;padding:8px;border-radius:9px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:var(--tr);margin-bottom:6px;}
.ppbtn.dm{background:var(--ad);color:#fff;}
.ppbtn.dm:hover{background:var(--accent);}
.ppbtn.fr{background:var(--s3);color:var(--t2);border:1px solid var(--border);}
.ppbtn.fr:hover{border-color:var(--accent);color:var(--accent);}

/* animations */
@keyframes rise{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:700px){
  #sb{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);}
  #sb.open{transform:translateX(0);box-shadow:4px 0 40px rgba(0,0,0,.6);}
  .ham{display:flex!important;}
  .acard{padding:32px 24px;border-radius:20px;}
  .msgs{padding:12px 14px;}
  .ch{padding:10px 14px;}
  .izone{padding:8px 14px 12px;}
  #mbar{padding:6px 14px;}
  .modal{padding:24px 20px;}
}
@media(max-width:360px){
  .acard{padding:28px 18px;}
  .alogo{font-size:28px;}
}
</style>
</head>
<body>
<div id="toast"></div>
<div id="overlay" onclick="closeSb()"></div>

<!-- ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê -->
<div id="auth">
  <div class="acard">
    <div class="alogo">FlickChat</div>
    <div class="atag">Your school's chat ‚ö° fast, private, free</div>
    <div class="tabs">
      <button class="tab on" id="tlog" onclick="setTab('login')">Log In</button>
      <button class="tab" id="tsig" onclick="setTab('signup')">Sign Up</button>
    </div>
    <label class="lbl">Username</label>
    <input class="inp" id="au" placeholder="your_username" autocomplete="username" onkeydown="if(event.key==='Enter')doAuth()"/>
    <label class="lbl">Password</label>
    <input class="inp" id="ap" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doAuth()"/>
    <button class="btn-p" id="auth-btn" onclick="doAuth()">Log In</button>
    <div class="aerr" id="aerr"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- SIDEBAR -->
  <div id="sb">
    <div class="sbtop">
      <div class="sblogo">FlickChat</div>
      <div style="display:flex;gap:4px">
        <button class="ib" title="New DM" onclick="openDMModal()">‚úâ</button>
        <button class="ib" title="New group" onclick="openGCModal()">üë•</button>
      </div>
    </div>

    <div class="sbscr">
      <div class="sec">Channels <button onclick="openM('m-newch')" title="Add channel">Ôºã</button></div>
      <div id="ch-list"></div>
      <div class="sec">Direct Messages <button onclick="openDMModal()" title="New DM">Ôºã</button></div>
      <div id="dm-list"></div>
      <div class="sec">Group Chats <button onclick="openGCModal()" title="New group">Ôºã</button></div>
      <div id="gc-list"></div>
    </div>

    <div class="sbfoot" onclick="openSettings('profile')">
      <div class="av sz36" id="foot-av"></div>
      <div class="fn">
        <div class="un" id="foot-name">‚Äî</div>
        <div class="us">Online</div>
      </div>
      <button class="ib" onclick="event.stopPropagation();openSettings('profile')">‚öô</button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div class="ch">
      <button class="ib ham" id="hambtn" onclick="openSb()">‚ò∞</button>
      <div class="ci" id="ci">#</div>
      <div>
        <div class="cn" id="cn">general</div>
        <div class="cd" id="cd">Welcome to FlickChat</div>
      </div>
    </div>

    <div id="mbar"></div>
    <div class="msgs" id="msgs"></div>

    <div id="rstrip">
      <span>‚Ü© Replying to <b id="rstrip-name" style="color:var(--accent)"></b></span>
      <button class="rstripclose" onclick="cancelReply()">‚úï</button>
    </div>

    <div class="izone">
      <div class="ibox">
        <textarea id="minput" rows="1" placeholder="Message‚Ä¶" oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <button class="sbtn" onclick="sendMsg()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->

<!-- SETTINGS -->
<div class="mbg" id="m-settings" style="display:none">
  <div class="modal" style="max-width:480px">
    <button class="mclose" onclick="closeM('m-settings')">‚úï</button>
    <h3>Settings</h3>
    <div class="msub">Profile, friends &amp; requests</div>
    <div class="stabs">
      <button class="stab on" onclick="stab('profile')">Profile</button>
      <button class="stab" onclick="stab('friends')">Friends</button>
      <button class="stab" onclick="stab('requests')">Requests <span id="rbadge"></span></button>
    </div>

    <div class="ssec on" id="ss-profile">
      <div class="avpick">
        <div class="avprev" id="sav"></div>
        <div class="avopts">
          <button class="avopt" onclick="document.getElementById('avfile').click()">üìÅ Upload image</button>
          <input id="avfile" type="file" accept="image/*" style="display:none" onchange="avFile(event)"/>
          <button class="avopt" onclick="toggleUrlWrap()">üîó Use image URL</button>
        </div>
      </div>
      <div class="mf" id="url-wrap" style="display:none">
        <label class="lbl">Image URL</label>
        <input class="inp" id="avurl" placeholder="https://‚Ä¶"/>
      </div>
      <div class="mf">
        <label class="lbl">Display Name</label>
        <input class="inp" id="sdn" placeholder="Your display name"/>
      </div>
      <div class="mf">
        <label class="lbl">Status</label>
        <input class="inp" id="sst" placeholder="What's on your mind?"/>
      </div>
      <button class="btn-p" onclick="saveProfile()">Save Profile</button>
    </div>

    <div class="ssec" id="ss-friends">
      <div class="mf">
        <label class="lbl">Add friend by username</label>
        <div style="display:flex;gap:8px">
          <input class="inp" id="frinput" placeholder="username" style="flex:1;margin:0" onkeydown="if(event.key==='Enter')sendFR()"/>
          <button class="btn-p" style="width:auto;padding:11px 16px" onclick="sendFR()">Send</button>
        </div>
      </div>
      <div class="lbl" style="margin-bottom:8px">Your friends</div>
      <div class="ulist" id="friends-list"></div>
    </div>

    <div class="ssec" id="ss-requests">
      <div class="lbl" style="margin-bottom:8px">Incoming friend requests</div>
      <div class="ulist" id="reqs-list"></div>
    </div>
  </div>
</div>

<!-- NEW CHANNEL -->
<div class="mbg" id="m-newch" style="display:none">
  <div class="modal">
    <button class="mclose" onclick="closeM('m-newch')">‚úï</button>
    <h3>New Channel</h3>
    <div class="msub">Create a public channel for everyone</div>
    <div class="mf"><label class="lbl">Channel Name</label><input class="inp" id="newchname" placeholder="e.g. gaming" onkeydown="if(event.key==='Enter')createCh()"/></div>
    <button class="btn-p" onclick="createCh()">Create Channel</button>
  </div>
</div>

<!-- NEW DM -->
<div class="mbg" id="m-dm" style="display:none">
  <div class="modal">
    <button class="mclose" onclick="closeM('m-dm')">‚úï</button>
    <h3>New Direct Message</h3>
    <div class="msub">Start a private chat with a friend</div>
    <div class="ulist" id="dm-flist"></div>
  </div>
</div>

<!-- NEW GC -->
<div class="mbg" id="m-gc" style="display:none">
  <div class="modal">
    <button class="mclose" onclick="closeM('m-gc')">‚úï</button>
    <h3>Create Group Chat</h3>
    <div class="msub">Name your group and pick friends to add</div>
    <div class="mf"><label class="lbl">Group Name</label><input class="inp" id="gcname" placeholder="e.g. The Lads üî•" onkeydown="if(event.key==='Enter')createGC()"/></div>
    <div class="lbl" style="margin-bottom:8px">Select friends</div>
    <div class="ulist" id="gc-flist"></div>
    <button class="btn-p" style="margin-top:14px" onclick="createGC()">Create Group</button>
  </div>
</div>

<!-- PROFILE POPUP -->
<div id="ppop" style="display:none" class="ppop">
  <div style="margin-bottom:12px"><div class="av sz56" id="pp-av"></div></div>
  <div class="ppname" id="pp-name"></div>
  <div class="ppstatus" id="pp-status"></div>
  <div id="pp-online"></div>
  <button class="ppbtn dm" id="pp-dm">üí¨ Message</button>
  <button class="ppbtn fr" id="pp-fr">‚ûï Add Friend</button>
</div>

<!-- ‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, getDocs, collection, query, orderBy, limit, onSnapshot, where, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const FB = {
  apiKey: "AIzaSyDNMt0bgAbjFxjunAz_fP4LIi_g5N2QSuk",
  authDomain: "am-hair-and-beauty.firebaseapp.com",
  projectId: "am-hair-and-beauty",
  storageBucket: "am-hair-and-beauty.firebasestorage.app",
  messagingSenderId: "683802152688",
  appId: "1:683802152688:web:94598e2a32e1b98a8fbc35"
};

const fbApp = initializeApp(FB);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);
const store = getStorage(fbApp);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ME=null, CONVO=null, REPLY=null;
let pc={}, onl={}, pendAv=null, gcSel=[];
let unsubs=[], unsubMsgs=null, unsubMbar=null;
let myFriends=[], inReqs=[], allChs=[], myGCs=[], myDMs={};
let openEt=null;
const EMOJIS=['üëç','‚ù§Ô∏è','üî•','üòÇ','üòÆ','üíÄ','üéâ','üíØ','üò¢','üëÄ'];

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const toEmail = u => u.toLowerCase().replace(/[^a-z0-9_]/g,'')+'@schoolapp.app';
const dmId    = (a,b) => [a,b].sort().join('__');
const init    = n => (n||'?').slice(0,2).toUpperCase();
const esc     = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const fmtT    = ts => { if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); };
const fmtD    = ts => { if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); const n=new Date(); if(d.toDateString()===n.toDateString()) return 'Today'; const y=new Date(n); y.setDate(y.getDate()-1); if(d.toDateString()===y.toDateString()) return 'Yesterday'; return d.toLocaleDateString([],{month:'long',day:'numeric'}); };

function toast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('on'); setTimeout(()=>t.classList.remove('on'),2800); }
window.closeM=id=>{ document.getElementById(id).style.display='none'; }
window.openM=id=>{ document.getElementById(id).style.display='flex'; }
function avHtml(av,nm){ return av?`<img src="${esc(av)}" alt="" loading="lazy"/>`:`<span>${init(nm)}</span>`; }
function setAv(el,av,nm){ el.innerHTML=avHtml(av,nm); }

// ‚îÄ‚îÄ FRIENDLY ERROR MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function friendlyErr(e){
  switch(e.code){
    case 'auth/invalid-credential':
    case 'auth/wrong-password':
    case 'auth/user-not-found':       return 'Wrong username or password.';
    case 'auth/email-already-in-use': return 'Username already registered ‚Äî try logging in instead.';
    case 'auth/weak-password':        return 'Password must be at least 6 characters.';
    case 'auth/too-many-requests':    return 'Too many attempts ‚Äî wait a few minutes and try again.';
    case 'auth/network-request-failed': return 'Network error ‚Äî check your internet connection.';
    case 'auth/operation-not-allowed':
    case 'auth/configuration-not-found':
      return '‚ö†Ô∏è Email/Password login is not enabled. Go to Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Enable Email/Password.';
    case 'auth/invalid-api-key':
    case 'auth/invalid-app-credential':
      return '‚ö†Ô∏è Invalid Firebase API key ‚Äî double-check your config.';
    default: return e.message || e.code || 'Something went wrong.';
  }
}

// ‚îÄ‚îÄ AUTH LOADING STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setAuthLoading(on){
  const btn=document.getElementById('auth-btn');
  const au=document.getElementById('au');
  const ap=document.getElementById('ap');
  btn.disabled=on; au.disabled=on; ap.disabled=on;
  if(on) btn.textContent='Please wait‚Ä¶';
  else btn.textContent=authMode==='login'?'Log In':'Sign Up';
}

async function getP(uid){
  if(pc[uid]) return pc[uid];
  try{ const s=await getDoc(doc(db,'users',uid)); const p=s.exists()?s.data():{username:uid,displayName:uid,avatar:'',status:''}; pc[uid]=p; return p; }
  catch{ return {username:uid,displayName:uid,avatar:'',status:''}; }
}
function invP(uid){ delete pc[uid]; }

// ‚îÄ‚îÄ PRESENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function goOnline(uid){ try{ await setDoc(doc(db,'presence',uid),{online:true,ts:serverTimestamp()},{merge:true}); }catch{} }
async function goOffline(uid){ if(!uid)return; try{ await setDoc(doc(db,'presence',uid),{online:false,ts:serverTimestamp()},{merge:true}); }catch{} }
function watchPres(uids,cb){ uids.forEach(uid=>{ const u=onSnapshot(doc(db,'presence',uid),s=>{ onl[uid]=!!(s.data()||{}).online; cb(); }); unsubs.push(u); }); }

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let authMode='login';
window.setTab=m=>{ authMode=m; document.getElementById('tlog').classList.toggle('on',m==='login'); document.getElementById('tsig').classList.toggle('on',m==='signup'); document.getElementById('auth-btn').textContent=m==='login'?'Log In':'Sign Up'; };

window.doAuth=async()=>{
  const u=document.getElementById('au').value.trim();
  const p=document.getElementById('ap').value;
  const err=document.getElementById('aerr');
  err.textContent='';

  if(!u||!p){err.textContent='Fill in both fields.';return;}
  if(p.length<6){err.textContent='Password must be at least 6 characters.';return;}

  setAuthLoading(true);

  try{
    if(authMode==='signup'){
      const cl=u.toLowerCase().replace(/[^a-z0-9_]/g,'');
      if(cl.length<3){err.textContent='Username needs 3+ chars (letters, numbers, _).';setAuthLoading(false);return;}
      const cr=await createUserWithEmailAndPassword(auth,toEmail(cl),p);
      await setDoc(doc(db,'users',cr.user.uid),{
        username:cl,displayName:cl,avatar:'',status:'',friends:[],uid:cr.user.uid
      });
    } else {
      await signInWithEmailAndPassword(auth,toEmail(u),p);
    }
  } catch(e){
    err.textContent=friendlyErr(e);
    setAuthLoading(false);
  }
};

onAuthStateChanged(auth, async user=>{
  if(user){
    try{
      const s=await getDoc(doc(db,'users',user.uid));
      if(!s.exists()){
        // User exists in Auth but not Firestore ‚Äî create their profile
        // This can happen if signup was interrupted
        const username=user.email.replace('@flickchat.app','');
        await setDoc(doc(db,'users',user.uid),{
          username, displayName:username, avatar:'', status:'', friends:[], uid:user.uid
        });
        const s2=await getDoc(doc(db,'users',user.uid));
        ME={uid:user.uid,...s2.data()};
      } else {
        ME={uid:user.uid,...s.data()};
      }
      pc[ME.uid]=ME;
      await goOnline(ME.uid);
      window.addEventListener('beforeunload',()=>goOffline(ME.uid));
      setAuthLoading(false);
      boot();
    } catch(e){
      // Firestore read failed ‚Äî most likely rules blocking it
      document.getElementById('aerr').textContent=
        '‚ö†Ô∏è Could not load your profile. Check Firestore rules allow authenticated reads on the "users" collection.';
      setAuthLoading(false);
      await signOut(auth);
    }
  } else {
    ME=null;
    document.getElementById('auth').style.display='flex';
    document.getElementById('app').classList.remove('on');
    unsubs.forEach(u=>u()); unsubs=[];
    setAuthLoading(false);
  }
});

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function boot(){
  document.getElementById('auth').style.display='none';
  document.getElementById('app').classList.add('on');
  renderFoot();
  await loadChs();
  listenFriends(); listenFRs(); listenGCs(); listenDMs();
}
function renderFoot(){
  setAv(document.getElementById('foot-av'),ME.avatar,ME.displayName||ME.username);
  document.getElementById('foot-name').textContent=ME.displayName||ME.username;
}

// ‚îÄ‚îÄ CHANNELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadChs(){
  try{
    const s=await getDocs(collection(db,'channels'));
    allChs=[];
    s.forEach(d=>allChs.push({id:d.id,...d.data()}));
    if(!allChs.length){
      await setDoc(doc(db,'channels','general'),{name:'general',createdAt:serverTimestamp()});
      allChs=[{id:'general',name:'general'}];
    }
    renderChList();
    if(!CONVO) selectConvo({type:'channel',id:allChs[0].id,name:allChs[0].name});
  } catch(e){
    document.getElementById('msgs').innerHTML=
      `<div style="padding:20px;color:var(--rose);font-size:13px">
        ‚ö†Ô∏è Could not load channels: ${esc(e.message)}<br><br>
        Make sure your Firestore rules allow authenticated users to read/write.<br>
        <code style="font-size:11px;color:var(--t2)">allow read, write: if request.auth != null;</code>
      </div>`;
  }
}
function renderChList(){
  document.getElementById('ch-list').innerHTML=allChs.map(c=>`
    <div class="row${CONVO?.id===c.id?' on':''}" onclick="selectConvo({type:'channel',id:'${c.id}',name:'${esc(c.name)}'})">
      <span class="ri">#</span><span class="rn">${esc(c.name)}</span>
    </div>`).join('');
}
window.createCh=async()=>{
  const n=document.getElementById('newchname').value.trim().toLowerCase().replace(/\s+/g,'-');
  if(!n){toast('Enter a name');return;}
  await setDoc(doc(db,'channels',n),{name:n,createdAt:serverTimestamp()});
  closeM('m-newch'); document.getElementById('newchname').value='';
  await loadChs(); toast('Channel created!');
};

// ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenFriends(){
  const u=onSnapshot(doc(db,'users',ME.uid),async s=>{
    const d=s.data()||{}; ME={...ME,...d}; myFriends=d.friends||[];
    invP(ME.uid); pc[ME.uid]=ME;
    renderFoot(); renderDMList();
    watchPres(myFriends,()=>{ renderDMList(); if(CONVO&&CONVO.type!=='channel') refreshMbar(); });
  });
  unsubs.push(u);
}
function listenFRs(){
  const u=onSnapshot(query(collection(db,'friendRequests'),where('to','==',ME.uid),where('status','==','pending')),s=>{
    inReqs=[]; s.forEach(d=>inReqs.push({id:d.id,...d.data()}));
    document.getElementById('rbadge').textContent=inReqs.length?`(${inReqs.length})`:'';
  });
  unsubs.push(u);
}

window.openSettings=tab=>{ openM('m-settings'); stab(tab||'profile'); document.getElementById('sdn').value=ME.displayName||ME.username||''; document.getElementById('sst').value=ME.status||''; refreshSav(); };
window.stab=t=>{ document.querySelectorAll('.stab').forEach((b,i)=>b.classList.toggle('on',['profile','friends','requests'][i]===t)); document.querySelectorAll('.ssec').forEach(s=>s.classList.remove('on')); document.getElementById('ss-'+t).classList.add('on'); if(t==='friends')renderFriendsList(); if(t==='requests')renderReqsList(); };
function refreshSav(){ const el=document.getElementById('sav'); el.innerHTML=ME.avatar?`<img src="${esc(ME.avatar)}" alt=""/>`:`<span style="font-size:22px;font-weight:800">${init(ME.displayName||ME.username)}</span>`; }
window.toggleUrlWrap=()=>{ const w=document.getElementById('url-wrap'); w.style.display=w.style.display==='none'?'block':'none'; };
window.avFile=e=>{ const f=e.target.files[0]; if(!f)return; pendAv={type:'file',val:f}; document.getElementById('sav').innerHTML=`<img src="${URL.createObjectURL(f)}" alt=""/>`; toast('File ready ‚Äî click Save Profile'); };
window.saveProfile=async()=>{
  let av=ME.avatar||'';
  const ui=document.getElementById('avurl').value.trim();
  if(ui) pendAv={type:'url',val:ui};
  if(pendAv){
    if(pendAv.type==='file'){
      try{ const r=sRef(store,`avatars/${ME.uid}`); await uploadBytes(r,pendAv.val); av=await getDownloadURL(r); }
      catch{ av=URL.createObjectURL(pendAv.val); toast('Storage not configured ‚Äî avatar works this session only.'); }
    } else { av=pendAv.val; }
    pendAv=null;
  }
  const dn=document.getElementById('sdn').value.trim()||ME.username;
  const st=document.getElementById('sst').value.trim();
  await updateDoc(doc(db,'users',ME.uid),{avatar:av,displayName:dn,status:st});
  ME.avatar=av; ME.displayName=dn; ME.status=st; invP(ME.uid); pc[ME.uid]=ME;
  renderFoot(); refreshSav(); toast('Profile saved ‚ú®');
};

async function renderFriendsList(){
  const el=document.getElementById('friends-list');
  if(!myFriends.length){el.innerHTML='<div class="empty">No friends yet ‚Äî add some! üëã</div>';return;}
  el.innerHTML='<div class="empty">Loading‚Ä¶</div>';
  const rows=await Promise.all(myFriends.map(async uid=>{
    const p=await getP(uid); const name=p.displayName||p.username;
    return `<div class="urow"><div class="av sz32">${avHtml(p.avatar,name)}</div><div class="urinfo"><div class="urname">${esc(name)}</div><div class="ursub">${onl[uid]?'üü¢ Online':'‚ö´ Offline'}</div></div><button class="urbtn u-rem" onclick="removeFriend('${uid}')">Remove</button></div>`;
  }));
  el.innerHTML=rows.join('');
}
window.removeFriend=async uid=>{ await updateDoc(doc(db,'users',ME.uid),{friends:arrayRemove(uid)}); await updateDoc(doc(db,'users',uid),{friends:arrayRemove(ME.uid)}); toast('Friend removed'); renderFriendsList(); };

window.sendFR=async()=>{
  const t=document.getElementById('frinput').value.trim().toLowerCase();
  if(!t){toast('Enter a username');return;}
  if(t===ME.username){toast("Can't add yourself üòÖ");return;}
  const s=await getDocs(query(collection(db,'users'),where('username','==',t)));
  if(s.empty){toast('User not found');return;}
  const tu=s.docs[0].data();
  if(myFriends.includes(tu.uid)){toast('Already friends!');return;}
  const ex=await getDocs(query(collection(db,'friendRequests'),where('from','==',ME.uid),where('to','==',tu.uid),where('status','==','pending')));
  if(!ex.empty){toast('Request already sent');return;}
  await addDoc(collection(db,'friendRequests'),{from:ME.uid,fromUser:ME.username,to:tu.uid,toUser:tu.username,status:'pending',createdAt:serverTimestamp()});
  document.getElementById('frinput').value=''; toast('Friend request sent üéâ');
};
function renderReqsList(){
  const el=document.getElementById('reqs-list');
  if(!inReqs.length){el.innerHTML='<div class="empty">No pending requests</div>';return;}
  el.innerHTML=inReqs.map(r=>`<div class="urow"><div class="av sz32"><span>${init(r.fromUser)}</span></div><div class="urname" style="flex:1">${esc(r.fromUser)}</div><button class="urbtn u-acc" onclick="acceptFR('${r.id}','${r.from}')">Accept</button><button class="urbtn u-rem" style="margin-left:4px" onclick="declineFR('${r.id}')">‚úï</button></div>`).join('');
}
window.acceptFR=async(id,uid)=>{ await updateDoc(doc(db,'friendRequests',id),{status:'accepted'}); await updateDoc(doc(db,'users',ME.uid),{friends:arrayUnion(uid)}); await updateDoc(doc(db,'users',uid),{friends:arrayUnion(ME.uid)}); toast('Friend added üéâ'); };
window.declineFR=async id=>{ await deleteDoc(doc(db,'friendRequests',id)); toast('Request declined'); };

// ‚îÄ‚îÄ DMs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenDMs(){ const u=onSnapshot(query(collection(db,'dms'),where('members','array-contains',ME.uid)),s=>{ myDMs={}; s.forEach(d=>myDMs[d.id]={id:d.id,...d.data()}); renderDMList(); }); unsubs.push(u); }
function renderDMList(){
  const el=document.getElementById('dm-list');
  const dms=Object.values(myDMs);
  if(!dms.length){el.innerHTML='';return;}
  Promise.all(dms.map(async dm=>{ const oid=dm.members.find(u=>u!==ME.uid); const p=await getP(oid); return {dm,p,oid,isOn:onl[oid]}; })).then(items=>{
    el.innerHTML=items.map(({dm,p,oid,isOn})=>`
      <div class="row${CONVO?.id===dm.id?' on':''}" onclick="selectConvo({type:'dm',id:'${dm.id}',name:'${esc(p.displayName||p.username)}',otherId:'${oid}'})">
        <div class="av sz28" style="position:relative;flex-shrink:0">${avHtml(p.avatar,p.displayName||p.username)}${isOn?'<div class="odot sm"></div>':''}</div>
        <span class="rn">${esc(p.displayName||p.username)}</span>
      </div>`).join('');
  });
}
window.openDMModal=async()=>{
  const el=document.getElementById('dm-flist');
  if(!myFriends.length){el.innerHTML='<div class="empty">Add friends first!</div>';}
  else{ const rows=await Promise.all(myFriends.map(async uid=>{ const p=await getP(uid); const nm=p.displayName||p.username; return `<div class="urow"><div class="av sz32">${avHtml(p.avatar,nm)}</div><div class="urname" style="flex:1">${esc(nm)}</div><button class="urbtn u-msg" onclick="startDM('${uid}')">Message</button></div>`; })); el.innerHTML=rows.join(''); }
  openM('m-dm');
};
window.startDM=async uid=>{ const p=await getP(uid); const id=dmId(ME.uid,uid); await setDoc(doc(db,'dms',id),{members:[ME.uid,uid],createdAt:serverTimestamp()},{merge:true}); closeM('m-dm'); selectConvo({type:'dm',id,name:p.displayName||p.username,otherId:uid}); };

// ‚îÄ‚îÄ GROUP CHATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenGCs(){ const u=onSnapshot(query(collection(db,'groupchats'),where('members','array-contains',ME.uid)),s=>{ myGCs=[]; s.forEach(d=>myGCs.push({id:d.id,...d.data()})); renderGCList(); }); unsubs.push(u); }
function renderGCList(){
  const el=document.getElementById('gc-list');
  if(!myGCs.length){el.innerHTML='';return;}
  el.innerHTML=myGCs.map(gc=>`<div class="row${CONVO?.id===gc.id?' on':''}" onclick="selectConvo({type:'gc',id:'${gc.id}',name:'${esc(gc.name)}',members:${JSON.stringify(gc.members)}})"><span class="ri">üë•</span><span class="rn">${esc(gc.name)}</span></div>`).join('');
}
window.openGCModal=async()=>{
  gcSel=[];
  const el=document.getElementById('gc-flist');
  if(!myFriends.length){el.innerHTML='<div class="empty">Add friends first!</div>';}
  else{ const rows=await Promise.all(myFriends.map(async uid=>{ const p=await getP(uid); const nm=p.displayName||p.username; return `<div class="urow"><div class="av sz32">${avHtml(p.avatar,nm)}</div><div class="urname" style="flex:1">${esc(nm)}</div><div class="chk" id="gck-${uid}" onclick="toggleGCSel('${uid}')"></div></div>`; })); el.innerHTML=rows.join(''); }
  openM('m-gc');
};
window.toggleGCSel=uid=>{ const el=document.getElementById('gck-'+uid); if(gcSel.includes(uid)){gcSel=gcSel.filter(u=>u!==uid);el.classList.remove('on');}else{gcSel.push(uid);el.classList.add('on');} };
window.createGC=async()=>{
  const n=document.getElementById('gcname').value.trim();
  if(!n){toast('Enter a group name');return;} if(!gcSel.length){toast('Select at least one friend');return;}
  const members=[ME.uid,...gcSel];
  const r=await addDoc(collection(db,'groupchats'),{name:n,members,createdBy:ME.uid,createdAt:serverTimestamp()});
  closeM('m-gc'); document.getElementById('gcname').value=''; toast('Group created üéâ');
  selectConvo({type:'gc',id:r.id,name:n,members});
};

// ‚îÄ‚îÄ SELECT CONVO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.selectConvo=async convo=>{
  CONVO=convo; REPLY=null;
  document.getElementById('rstrip').classList.remove('on');
  document.getElementById('msgs').innerHTML='';
  if(unsubMsgs){unsubMsgs();unsubMsgs=null;}
  if(unsubMbar){unsubMbar();unsubMbar=null;}

  document.getElementById('ci').textContent=convo.type==='channel'?'#':convo.type==='dm'?'üí¨':'üë•';
  document.getElementById('cn').textContent=convo.name;
  document.getElementById('cd').textContent=convo.type==='channel'?'Public channel':convo.type==='dm'?'Direct message':'Group chat';
  document.getElementById('minput').placeholder=`Message ${convo.type==='channel'?'#':''}${convo.name}‚Ä¶`;

  renderChList(); renderDMList(); renderGCList();

  if(convo.type!=='channel'){ document.getElementById('mbar').classList.add('on'); await renderMbar(); startMbarWatch(); }
  else { document.getElementById('mbar').classList.remove('on'); document.getElementById('mbar').innerHTML=''; }

  closeSb(); listenMsgs();
};

function getMbarUids(){ if(!CONVO)return[]; if(CONVO.type==='dm')return[ME.uid,CONVO.otherId]; if(CONVO.type==='gc')return CONVO.members||[]; return []; }
async function renderMbar(){
  const bar=document.getElementById('mbar'); const uids=getMbarUids();
  const chips=await Promise.all(uids.map(async uid=>{ const p=await getP(uid); const nm=p.displayName||p.username; const isOn=onl[uid]; return `<div class="mchip${isOn?' live':''}"><div class="mav">${avHtml(p.avatar,nm)}</div><div class="mdot"></div><span>${esc(nm)}</span></div>`; }));
  bar.innerHTML=`<span class="mbarlbl">Members</span>`+chips.join('');
}
function startMbarWatch(){ const uids=getMbarUids(); const mu=uids.map(uid=>onSnapshot(doc(db,'presence',uid),s=>{onl[uid]=!!(s.data()||{}).online;if(CONVO&&CONVO.type!=='channel')renderMbar();})); unsubMbar=()=>mu.forEach(u=>u()); }
function refreshMbar(){ if(CONVO&&CONVO.type!=='channel')renderMbar(); }

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getMsgsRef(){ if(!CONVO)return null; if(CONVO.type==='channel')return collection(db,'channels',CONVO.id,'messages'); if(CONVO.type==='dm')return collection(db,'dms',CONVO.id,'messages'); if(CONVO.type==='gc')return collection(db,'groupchats',CONVO.id,'messages'); }
function listenMsgs(){
  const ref=getMsgsRef(); if(!ref)return;
  const q=query(ref,orderBy('ts'),limit(80));
  unsubMsgs=onSnapshot(q, async s=>{
    const msgs=[]; s.forEach(d=>msgs.push({id:d.id,...d.data()})); await renderMsgs(msgs);
  }, e=>{
    document.getElementById('msgs').innerHTML=
      `<div style="padding:20px;color:var(--rose);font-size:13px">
        ‚ö†Ô∏è Could not load messages: ${esc(e.message)}<br><br>
        Check your Firestore rules allow authenticated reads.
      </div>`;
  });
}

async function renderMsgs(msgs){
  const wrap=document.getElementById('msgs');
  if(!msgs.length){wrap.innerHTML='<div style="text-align:center;color:var(--t3);font-size:13px;padding:40px 0">No messages yet ‚Äî say hi! üëã</div>';return;}
  const uids=[...new Set(msgs.map(m=>m.uid).filter(Boolean))];
  await Promise.all(uids.map(getP));
  let html='',lastDay='';
  for(const m of msgs){
    const p=pc[m.uid]||{displayName:m.uid,username:m.uid,avatar:''};
    const nm=p.displayName||p.username||m.uid;
    const mine=m.uid===ME.uid;
    const day=fmtD(m.ts);
    if(day&&day!==lastDay){ html+=`<div class="dsep">${esc(day)}</div>`; lastDay=day; }
    let rqHtml='';
    if(m.replyTo) rqHtml=`<div class="rq" onclick="scrollToMsg('${m.replyTo.id}')"><div class="rqau">‚Ü© ${esc(m.replyTo.author)}</div><div class="rqtx">${esc(m.replyTo.text||'')}</div></div>`;
    let rcHtml='';
    if(m.reactions&&Object.keys(m.reactions).length){
      const g={};
      Object.entries(m.reactions).forEach(([uid,emoji])=>{ if(!g[emoji])g[emoji]=[]; g[emoji].push(uid); });
      rcHtml='<div class="reacts">'+Object.entries(g).map(([emoji,uids])=>`<button class="rp${uids.includes(ME.uid)?' mine':''}" onclick="toggleReact('${m.id}','${emoji}')">${emoji} <span>${uids.length}</span></button>`).join('')+'</div>';
    }
    const body=m.deleted
      ?`<div class="mdel">üö´ Message deleted</div>`
      :`${rqHtml}<div class="bub${mine?' me':''}">${esc(m.text||'')}</div>${rcHtml}`;
    html+=`<div class="mg" id="msg-${m.id}">
      <div class="av sz36" onclick="showProfile(event,'${m.uid}')" style="cursor:pointer;flex-shrink:0;align-self:flex-start;margin-top:2px">${avHtml(p.avatar,nm)}</div>
      <div class="mright">
        <div class="mmeta">
          <span class="mauth" style="color:${mine?'var(--accent)':'var(--t1)'}" onclick="showProfile(event,'${m.uid}')">${esc(nm)}</span>
          <span class="mtime">${fmtT(m.ts)}</span>
        </div>${body}
      </div>
      ${!m.deleted?`<div class="ma">
        <button class="ab" title="React" onclick="toggleEt(event,'${m.id}')">üòä</button>
        <button class="ab" title="Reply" onclick="setReply('${m.id}','${esc(nm)}','${esc((m.text||'').replace(/'/g,"\\'"))}')">‚Ü©</button>
        ${mine?`<button class="ab del" title="Delete" onclick="delMsg('${m.id}')">üóë</button>`:''}
        <div class="et" id="et-${m.id}" style="display:none">${EMOJIS.map(e=>`<button onclick="pickEmoji(event,'${m.id}','${e}')">${e}</button>`).join('')}</div>
      </div>`:''}
    </div>`;
  }
  wrap.innerHTML=html;
  wrap.scrollTop=wrap.scrollHeight;
}

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.sendMsg=async()=>{
  const inp=document.getElementById('minput'); const text=inp.value.trim();
  if(!text||!CONVO)return;
  inp.value=''; autoResize(inp);
  const ref=getMsgsRef(); if(!ref)return;
  const data={uid:ME.uid,text,ts:serverTimestamp(),reactions:{}};
  if(REPLY){data.replyTo={id:REPLY.id,author:REPLY.author,text:REPLY.text};}
  try{
    await addDoc(ref,data);
  } catch(e){
    toast('Could not send: '+e.message);
    inp.value=text; autoResize(inp); // restore on failure
  }
  REPLY=null; document.getElementById('rstrip').classList.remove('on');
};
window.handleKey=e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} };
window.autoResize=el=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; };

// ‚îÄ‚îÄ REPLY / DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setReply=(id,author,text)=>{ REPLY={id,author,text}; document.getElementById('rstrip-name').textContent=author; document.getElementById('rstrip').classList.add('on'); document.getElementById('minput').focus(); };
window.cancelReply=()=>{ REPLY=null; document.getElementById('rstrip').classList.remove('on'); };
window.scrollToMsg=id=>{ const el=document.getElementById('msg-'+id); if(el)el.scrollIntoView({behavior:'smooth',block:'center'}); };
window.delMsg=async id=>{ const ref=getMsgsRef(); if(!ref)return; try{ await updateDoc(doc(ref,id),{deleted:true,text:''}); }catch(e){ toast('Delete failed: '+e.message); } };

// ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.toggleEt=(e,id)=>{ e.stopPropagation(); const tr=document.getElementById('et-'+id); const vis=tr.style.display!=='none'; document.querySelectorAll('.et').forEach(t=>t.style.display='none'); openEt=null; if(!vis){tr.style.display='flex';openEt=id;} };
window.pickEmoji=(e,id,emoji)=>{ e.stopPropagation(); toggleReact(id,emoji); document.querySelectorAll('.et').forEach(t=>t.style.display='none'); openEt=null; };
window.toggleReact=async(id,emoji)=>{
  const ref=getMsgsRef(); if(!ref)return;
  try{
    const snap=await getDoc(doc(ref,id)); if(!snap.exists())return;
    const reactions=snap.data().reactions||{};
    if(reactions[ME.uid]===emoji){delete reactions[ME.uid];}else{reactions[ME.uid]=emoji;}
    await updateDoc(doc(ref,id),{reactions});
  } catch(e){ toast('React failed: '+e.message); }
};
document.addEventListener('click',()=>{ if(openEt){document.getElementById('et-'+openEt)?.style.setProperty('display','none');openEt=null;} });

// ‚îÄ‚îÄ PROFILE POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showProfile=async(e,uid)=>{
  e.stopPropagation();
  const pop=document.getElementById('ppop');
  const p=await getP(uid); const nm=p.displayName||p.username;
  setAv(document.getElementById('pp-av'),p.avatar,nm);
  document.getElementById('pp-name').textContent=nm;
  document.getElementById('pp-status').textContent=p.status||'';
  document.getElementById('pp-online').innerHTML=onl[uid]?'<div class="pponline">Online now</div>':'<div class="ppoffline">Offline</div>';
  const dmb=document.getElementById('pp-dm'), frb=document.getElementById('pp-fr');
  if(uid===ME.uid){dmb.style.display='none';frb.style.display='none';}
  else{
    dmb.style.display=''; frb.style.display='';
    dmb.onclick=()=>{pop.style.display='none';startDM(uid);};
    const isFr=myFriends.includes(uid);
    frb.textContent=isFr?'‚úÖ Friends':'‚ûï Add Friend';
    frb.disabled=isFr;
    frb.onclick=isFr?null:async()=>{ const ex=await getDocs(query(collection(db,'friendRequests'),where('from','==',ME.uid),where('to','==',uid),where('status','==','pending'))); if(!ex.empty){toast('Request already sent');return;} await addDoc(collection(db,'friendRequests'),{from:ME.uid,fromUser:ME.username,to:uid,toUser:p.username,status:'pending',createdAt:serverTimestamp()}); toast('Friend request sent üéâ'); pop.style.display='none'; };
  }
  const rect=e.target.closest('.av').getBoundingClientRect();
  const left=Math.min(rect.right+8,window.innerWidth-236);
  const top=Math.max(8,Math.min(rect.top,window.innerHeight-340));
  pop.style.left=left+'px'; pop.style.top=top+'px'; pop.style.display='block';
};
document.addEventListener('click',e=>{ const pop=document.getElementById('ppop'); if(pop.style.display!=='none'&&!pop.contains(e.target))pop.style.display='none'; });

// ‚îÄ‚îÄ SIDEBAR MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openSb=()=>{ document.getElementById('sb').classList.add('open'); document.getElementById('overlay').classList.add('on'); };
window.closeSb=()=>{ document.getElementById('sb').classList.remove('open'); document.getElementById('overlay').classList.remove('on'); };
</script>
</body>
</html>





