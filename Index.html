<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Chat</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f0f2f5; }

    #auth-screen, #chat-screen { 
      display: flex; flex-direction: column; align-items: center; 
      justify-content: center; min-height: 100vh; padding: 20px;
    }

    #chat-screen { display: none; justify-content: flex-start; }

    .card { background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }

    h2 { margin-bottom: 20px; color: #333; }

    input { width: 100%; padding: 10px; margin: 8px 0; 
            border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }

    button { width: 100%; padding: 10px; background: #4f46e5; color: white; 
             border: none; border-radius: 8px; cursor: pointer; font-size: 15px; margin-top: 8px; }
    button:hover { background: #4338ca; }

    #chat-container { width: 100%; max-width: 700px; margin: 20px auto; }

    #header { background: #4f46e5; color: white; padding: 15px 20px; 
               border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }

    #messages { background: white; height: 400px; overflow-y: auto; 
                padding: 15px; border-left: 1px solid #eee; border-right: 1px solid #eee; }

    .msg { margin: 8px 0; }
    .msg .sender { font-weight: bold; color: #4f46e5; font-size: 13px; }
    .msg .text { background: #f0f2f5; padding: 8px 12px; border-radius: 8px; 
                 display: inline-block; max-width: 80%; margin-top: 2px; }
    .msg.mine .text { background: #4f46e5; color: white; }
    .msg.mine { text-align: right; }
    .msg.mine .sender { color: #6366f1; }

    #input-area { display: flex; gap: 8px; padding: 12px; 
                  background: white; border: 1px solid #eee; border-radius: 0 0 12px 12px; }

    #msg-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    #send-btn { width: auto; margin: 0; padding: 10px 20px; }

    #logout-btn { background: rgba(255,255,255,0.2); width: auto; margin: 0; padding: 6px 12px; font-size: 13px; }

    #room-select { display: flex; gap: 8px; margin-bottom: 10px; }
    #room-select button { padding: 6px 14px; width: auto; margin: 0; 
                          background: white; color: #4f46e5; border: 2px solid #4f46e5; font-size: 13px; }
    #room-select button.active { background: #4f46e5; color: white; }

    .error { color: red; font-size: 13px; margin-top: 6px; }
    .small { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="card">
    <h2>ðŸ’¬ School Chat</h2>
    <input id="username-input" placeholder="Choose a username" maxlength="20"/>
    <input id="password-input" type="password" placeholder="Password"/>
    <button onclick="signup()">Sign Up</button>
    <button onclick="login()" style="background:#6366f1; margin-top:6px">Log In</button>
    <p class="error" id="auth-error"></p>
    <p class="small">Username = your display name AND login email (@chat.com)</p>
  </div>
</div>

<!-- CHAT SCREEN -->
<div id="chat-screen">
  <div id="chat-container">
    <div id="header">
      <span>ðŸ’¬ <strong id="room-label">general</strong></span>
      <div style="display:flex; align-items:center; gap:10px">
        <span id="user-label" style="font-size:13px"></span>
        <button id="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    <div id="room-select">
      <button class="active" onclick="switchRoom('general', this)">general</button>
      <button onclick="switchRoom('random', this)">random</button>
      <button onclick="switchRoom('homework', this)">homework</button>
    </div>
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendMsg()"/>
      <button id="send-btn" onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ðŸ”¥ REPLACE THIS WITH YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDNMt0bgAbjFxjunAz_fP4LIi_g5N2QSuk",
    authDomain: "am-hair-and-beauty.firebaseapp.com",
    projectId: "am-hair-and-beauty",
    storageBucket: "am-hair-and-beauty.firebasestorage.app",
    messagingSenderId: "683802152688",
    appId: "1:683802152688:web:94598e2a32e1b98a8fbc35"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentRoom = "general";
  let unsubscribe = null;

  // Convert username to fake email for Firebase Auth
  const toEmail = u => u.toLowerCase().replace(/[^a-z0-9]/g,'') + "@schoolchat.app";

  window.signup = async () => {
    const u = document.getElementById('username-input').value.trim();
    const p = document.getElementById('password-input').value;
    if (!u || !p) return;
    try {
      await createUserWithEmailAndPassword(auth, toEmail(u), p);
      // Store display name in Firestore (optional, auth currentUser will store it)
    } catch(e) {
      document.getElementById('auth-error').textContent = e.message;
    }
  };

  window.login = async () => {
    const u = document.getElementById('username-input').value.trim();
    const p = document.getElementById('password-input').value;
    try {
      await signInWithEmailAndPassword(auth, toEmail(u), p);
    } catch(e) {
      document.getElementById('auth-error').textContent = e.message;
    }
  };

  window.logout = () => signOut(auth);

  window.sendMsg = async () => {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text || !currentUser) return;
    input.value = '';
    await addDoc(collection(db, 'rooms', currentRoom, 'messages'), {
      text,
      username: currentUser,
      timestamp: serverTimestamp()
    });
  };

  window.switchRoom = (room, btn) => {
    currentRoom = room;
    document.getElementById('room-label').textContent = room;
    document.querySelectorAll('#room-select button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('messages').innerHTML = '';
    if (unsubscribe) unsubscribe();
    listenToRoom();
  };

  function listenToRoom() {
    const q = query(collection(db, 'rooms', currentRoom, 'messages'), orderBy('timestamp'), limit(100));
    unsubscribe = onSnapshot(q, snapshot => {
      const msgs = document.getElementById('messages');
      msgs.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const mine = d.username === currentUser;
        msgs.innerHTML += `
          <div class="msg ${mine ? 'mine' : ''}">
            <div class="sender">${d.username}</div>
            <div class="text">${d.text}</div>
          </div>`;
      });
      msgs.scrollTop = msgs.scrollHeight;
    });
  }

  onAuthStateChanged(auth, user => {
    if (user) {
      // Extract username from fake email
      currentUser = user.email.replace('@schoolchat.app','');
      document.getElementById('user-label').textContent = currentUser;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'flex';
      listenToRoom();
    } else {
      currentUser = null;
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('chat-screen').style.display = 'none';
      if (unsubscribe) unsubscribe();
    }
  });
</script>
</body>
</html>